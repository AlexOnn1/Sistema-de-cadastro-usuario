<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Conta</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .welcome-text { text-align: center; margin-bottom: 2rem; color: #444; }
        .action-buttons { display: flex; flex-direction: column; gap: 1rem; width: 100%; }
        .btn-danger { background-color: #dc3545; color: white; border: none; }
        /* Botão Amarelo para o Admin */
        .btn-warning { background-color: #ffc107; color: #333; border: none; font-weight: bold; text-align: center; text-decoration: none; padding: 0.75rem; border-radius: 8px; display: block;}
        .btn-logout { background-color: #6c757d; color: white; text-align: center; text-decoration: none; display: block; padding: 0.75rem; border-radius: 8px; font-weight: bold;}
        
        #form-editar { margin-top: 1.5rem; border-top: 1px solid #ccc; padding-top: 1rem; }
    </style>
</head>
<body>
    <section class="container">
        <h1>Minha Conta</h1>
        
        <p class="welcome-text">Olá, <strong id="user-name">Usuário</strong>!</p>

        <div class="action-buttons" id="menu-principal">
            
            <a href="admin.html" id="btn-admin" class="hidden btn-warning">Voltar ao Painel Admin</a>

            <button class="btn btn-primary" onclick="mostrarEditar()">Editar Meus Dados</button>
            <button class="btn btn-danger" onclick="confirmarExclusao()">Excluir Minha Conta</button>
            
            <a href="../src/logout.php" class="btn-logout">Sair (Logout)</a>
        </div>

        <form id="form-editar" class="hidden">
            <h3>Atualizar Dados</h3>
            <p style="font-size: 0.8rem; color: #666; margin-bottom: 1rem; text-align: center;">Preencha apenas o que deseja alterar.</p>
            
            <div class="row-group">
                <div class="form-group" style="flex:1;">
                    <label for="nome">Nome</label>
                    <input type="text" id="nome" name="nome" maxlength="25">
                </div>
                <div class="form-group" style="flex:1;">
                    <label for="sobrenome">Sobrenome</label>
                    <input type="text" id="sobrenome" name="sobrenome" maxlength="25">
                </div>
            </div>

            <div class="form-group">
                <label for="idade">Idade</label>
                <input type="number" id="idade" name="idade" min="1" max="120">
            </div>

            <div class="form-group">
                <label for="novoEmail">Novo Email</label>
                <input type="email" id="novoEmail" name="novoEmail">
            </div>
            <div class="form-group">
                <label for="ConfirmarNovoEmail">Confirmar Novo Email</label>
                <input type="email" id="ConfirmarNovoEmail" name="ConfirmarNovoEmail">
            </div>

            <div class="form-group">
                <label for="NovaSenha">Nova Senha</label>
                <input type="password" id="NovaSenha" name="NovaSenha" minlength="8" maxlength="16">
            </div>
            <div class="form-group">
                <label for="ConfirmarNovaSenha">Confirmar Nova Senha</label>
                <input type="password" id="ConfirmarNovaSenha" name="ConfirmarNovaSenha" minlength="8" maxlength="16">
            </div>

            <div class="button-group" style="margin-top: 1rem;">
                <button type="button" class="btn btn-secondary" onclick="cancelarEdicao()">Voltar</button>
                <button type="submit" class="btn btn-primary">Salvar</button>
            </div>
            <div id="msg-edicao" style="margin-top: 10px; text-align: center; font-size: 0.9rem; font-weight: bold;"></div>
        </form>

    </section>

    <script>
        // --- CÓDIGO NOVO: Verifica quem é o usuário ---
        document.addEventListener('DOMContentLoaded', function() {
            fetch('../src/get_perfil.php')
            .then(res => res.json())
            .then(data => {
                if(data.sucesso) {
                    // 1. Atualiza o nome na tela
                    document.getElementById('user-name').innerText = data.nome;

                    // 2. Se for admin, mostra o botão mágico
                    if(data.tp_usuario === 'admin') {
                        document.getElementById('btn-admin').classList.remove('hidden');
                    }
                } else {
                    // Se não estiver logado, chuta pro login
                    window.location.href = 'login.html';
                }
            })
            .catch(err => console.error("Erro ao verificar sessão"));
        });
        // ----------------------------------------------

        function mostrarEditar() {
            document.getElementById('menu-principal').classList.add('hidden');
            document.getElementById('form-editar').classList.remove('hidden');
        }

        function cancelarEdicao() {
            document.getElementById('menu-principal').classList.remove('hidden');
            document.getElementById('form-editar').classList.add('hidden');
            document.getElementById('msg-edicao').innerHTML = '';
            document.getElementById('form-editar').reset();
        }

        function confirmarExclusao() {
            if(confirm("Tem certeza? Essa ação não pode ser desfeita e sua conta será apagada.")) {
                fetch('../src/Exclusao-de-dados.php')
                .then(res => res.json())
                .then(data => {
                    if(data.sucesso) {
                        alert("Conta excluída com sucesso.");
                        window.location.href = 'login.html';
                    } else {
                        alert("Erro: " + (data.erros ? data.erros[0] : 'Erro desconhecido'));
                    }
                })
                .catch(err => console.error(err));
            }
        }

        document.getElementById('form-editar').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const msgBox = document.getElementById('msg-edicao');
            msgBox.innerHTML = "Salvando...";
            msgBox.style.color = "#333";

            fetch('../src/Edicao-de-dados.php', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if(data.sucesso) {
                    msgBox.style.color = 'green';
                    msgBox.innerHTML = "Dados atualizados com sucesso!";
                    this.reset();
                    setTimeout(cancelarEdicao, 2000);
                } else {
                    msgBox.style.color = '#dc3545';
                    msgBox.innerHTML = data.erros ? data.erros.join('<br>') : 'Erro ao atualizar';
                }
            })
            .catch(err => {
                msgBox.style.color = '#dc3545';
                msgBox.innerHTML = "Erro de conexão com o servidor.";
            });
        });
    </script>
</body>
</html>